# Node.js Express Web App to Linux on Azure
# Build a Node.js Express app and deploy it to Azure as a Linux web app.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master
- develop
- release*
pool:
  vmImage: windows-latest

variables:

  # Azure Resource Manager connection created during pipeline creation
  azureSubscription: 'BlobConnection'

  #resource group
  ResourceGroupName: 'Zilis-Microservices'

  # Web app name
  webAppNameDev: 'AdminAppZilis'
  webAppNameProd: 'do we need prod?'

  storageAccount: 'zilisadminapp'
  storageContainerName: $web

  # Environment name
  prod: 'do we need prod?'

  # Agent VM image name
  vmImageName: 'windows-latest'

stages:
- stage: BuildDev
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/develop')
  displayName: Build Dev/test Code
  jobs:
  - job: Build
    displayName: Build
    variables:
       REACT_APP_ENV: 'test'
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '14.x'
      displayName: 'Install Node.js'
      
    - task: Npm@1
      displayName: NPM Install
      inputs:
        command: 'install'
        workingDir: '$(System.DefaultWorkingDirectory)'
        verbose: true
    - task: Npm@1
      displayName: NPM Build
      inputs:
        command: 'custom'
        workingDir: '$(System.DefaultWorkingDirectory)'
        customCommand: 'run build'
        
    # - task: CopyFiles@2
    #   displayName: 'Copy build directory to $(Build.ArtifactStagingDirectory)/build'
    #   inputs: 
    #     Contents: 'build/**'
    #     TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish build artifact'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/build'
        artifactName: dev
        artifactType: pipeline


- stage: DeployDevBlob
  displayName: Deploy To Dev Env
  dependsOn: BuildDev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: $(webAppNameDev)
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureFileCopy@4
            displayName: 'Copy files to blob storage: $(storageAccount)'
            inputs:
              SourcePath: '$(Pipeline.Workspace)/dev/**'
              Destination: AzureBlob
              storage: $(storageAccount)
              ContainerName: $(storageContainerName)
              azureSubscription: $(azureSubscription)
              CleanTargetBeforeCopy: true

- stage: DeployDev
  displayName: Deploy To Dev Env
  dependsOn: BuildDev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: $(webAppNameDev)
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureRmWebAppDeployment@4
            displayName: 'Azure App Service Deploy: $(webAppNameDev)'
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webApp
              WebAppName: $(webAppNameDev)
              packageForLinux: '$(Pipeline.Workspace)/dev/'
              RuntimeStack: 'NODE|14-lts'
              StartupCommand: 'serve -s build'

# - stage: BuildProd
#   condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')
#   displayName: Build Production Code
#   jobs:
#   - job: Build
#     displayName: Build
#     variables:
#       REACT_APP_ENV: 'production'
#     pool:
#       vmImage: $(vmImageName)

#     steps:
#     - task: NodeTool@0
#       inputs:
#         versionSpec: '10.x'
#       displayName: 'Install Node.js'
#     - script: |
#         npm install
#         npm run build --if-present
#         npm install -g serve
#         npm run tests --if-present
#       displayName: 'npm install, build and test'
#       workingDirectory: '$(System.DefaultWorkingDirectory)'
#     - task: ArchiveFiles@2
#       displayName: 'Archive Build as zip'
#       inputs:
#         rootFolderOrFile: $(System.DefaultWorkingDirectory)
#         includeRootFolder: false
#         archiveType: 'zip'
#         archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
#         replaceExistingArchive: true
#     - task: PublishPipelineArtifact@1
#       displayName: 'Publish build artifact'
#       inputs:
#         targetPath: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
#         artifactName: prod
#         publishLocation: pipeline

# - stage: DeployStage
#   displayName: Deploy to Stage Env
#   dependsOn: BuildProd
#   condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')
#   jobs:
#   - deployment: Deploy
#     displayName: Deploy
#     environment: $(prod)
#     pool:
#       vmImage: $(vmImageName)
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - task: AzureRmWebAppDeployment@4
#             inputs:
#               ConnectionType: 'AzureRM'
#               azureSubscription: $(azureSubscription) 
#               appType: 'webApp'
#               WebAppName: $(webAppNameProd)
#               deployToSlotOrASE: true
#               ResourceGroupName: $(ResourceGroupName)
#               SlotName: 'stage'
#               packageForLinux: '$(Pipeline.Workspace)/prod/$(Build.BuildId).zip'
#               RuntimeStack: 'NODE|10.10'
#               StartupCommand: 'serve -s build'

# - stage: SwapStageToProd
#   displayName: Swap Stage to Production Slot
#   dependsOn: DeployStage
#   condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')
#   jobs:
#   - deployment: SwapSlots
#     displayName: Swap Slots
#     environment: swapslots
#     pool:
#       vmImage: $(vmImageName)
#     strategy:
#      runOnce:
#        deploy:
#         steps:
#           - task: AzureAppServiceManage@0
#             inputs:
#               azureSubscription: $(azureSubscription)
#               Action: 'Swap Slots'
#               WebAppName: $(webAppNameProd)
#               ResourceGroupName: $(ResourceGroupName)
#               SourceSlot: 'stage'